<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Laundry Booking</title>
  <style>
    body { font-family: sans-serif; max-width: 920px; margin: auto; padding: 20px; }
    h2 { margin-top: 0; }
    input[type="text"], input[type="date"], select {
      width: 100%; margin-bottom: 10px; padding: 8px; font-size: 16px; box-sizing: border-box;
    }
    button { padding: 10px; background: #1f9d55; color: white; border: none; font-size: 16px; cursor: pointer; margin-bottom: 10px; border-radius:6px; }
    button.secondary { background:#666; }
    .row { display:flex; gap:20px; }
    .col { flex:1; }
    .cancel-button { background: red; color: white; border: none; padding: 4px 8px; font-size: 12px; margin-left: 10px; cursor: pointer; border-radius: 4px; }
    .reset-button { background: gray; margin-top: 10px; width:auto; padding:8px 12px; border-radius:6px; }
    .error { color: red; font-size: 14px; margin-bottom: 10px; }
    #weekDisplay { font-weight: bold; font-size: 18px; margin: 10px 0 20px; }
    .status-processing { color: orange; font-weight: bold; }
    .status-paid { color: blue; font-weight: bold; }
    .status-completed { color: green; font-weight: bold; }
    .today-badge { color: green; font-size: 12px; margin-left: 5px; }
    .small { font-size: 13px; color: #555; margin-bottom: 8px; }
    ul { padding-left: 18px; }
    label { display:block; font-size:14px; margin-bottom:4px; }
    .controls { display:flex; gap:10px; align-items:center; margin-bottom:12px; }
    .controls select, .controls input { flex:1; }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding:6px 8px; border-bottom: 1px solid #eee; }
    .legend { margin:10px 0; font-size:14px; }
    .badge { display:inline-block; padding:2px 6px; border-radius:4px; font-size:12px; margin-right:6px; }
    .badge.processing { background: #fff3cd; color:#856404; }
    .badge.paid { background: #cfe2ff; color:#084298; }
    .badge.completed { background: #d1e7dd; color:#0f5132; }
    .top-row { display:flex; gap:16px; align-items:center; margin-bottom:12px; }
    @media (max-width:900px) { .top-row { flex-direction: column; } .controls { flex-direction: column; } }
    .form-row { display: flex; gap: 18px; margin-top: 6px; align-items: flex-start; }
    .form-row .field { flex: 1; min-width: 0; display: flex; flex-direction: column; }
    .form-row label { margin-bottom: 6px; font-size: 14px; }
    @media (max-width: 600px) { .form-row { flex-direction: column; gap: 10px; } }
    .muted { color:#666; font-size:13px; }
  </style>
</head>
<body>
  <h2>Accomm Laundry Reservation</h2>
  <div class="small">Select machine, pick a future date, then choose time (schedule depends on machine & weekday).</div>

  <div class="top-row">
    <div style="flex:1">
      <label for="machine">Machine</label>
      <select id="machine">
        <option>Brothers Washer</option>
        <option>Brothers Dryer</option>
        <option>Sisters Washer</option>
        <option>Sisters Dryer</option>
      </select>
    </div>
    <div style="flex:2">
      <div class="form-row">
        <div class="field">
          <label for="name">Name</label>
          <input type="text" id="name" placeholder="Your Name and FT" />
        </div>
        <div class="field">
          <label for="room">Room</label>
          <input type="text" id="room" placeholder="Room Number" />
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <label for="date">Date</label>
      <input type="date" id="date" onchange="updateTimeSlots()" />
    </div>
    <div class="col">
      <label for="time">Time slot</label>
      <select id="time"><option value="">-- Select a Time Slot --</option></select>
    </div>
  </div>

  <div class="error" id="errorMessage"></div>
  <button onclick="startBooking()">Book Slot</button>

  <!-- Payment Dialog -->
  <dialog id="paymentDialog">
    <h3>Step 2: GCash Payment</h3>
    <p><strong>GCash Number:</strong> 0916-421-9818</p>
    <p><img src="https://upload.wikimedia.org/wikipedia/commons/d/d0/QR_code_for_mobile_English_Wikipedia.svg" style="width:100%;max-width:250px;"></p>
    <input type="text" id="reference" placeholder="Enter GCash Reference Number" />
    <div style="text-align:right; margin-top: 12px;">
      <button onclick="proceedToConfirmation()">Next</button>
      <button class="secondary" onclick="document.getElementById('paymentDialog').close()">Cancel</button>
    </div>
  </dialog>

  <!-- Confirmation Dialog -->
  <dialog id="confirmDialog">
    <h3>Step 3: Confirm Booking</h3>
    <p><strong>Machine:</strong> <span id="cMachine"></span></p>
    <p><strong>Name:</strong> <span id="cName"></span></p>
    <p><strong>Room:</strong> <span id="cRoom"></span></p>
    <p><strong>Date:</strong> <span id="cDate"></span></p>
    <p><strong>Time:</strong> <span id="cTime"></span></p>
    <p><strong>Reference:</strong> <span id="cRef"></span></p>
    <div style="text-align:right; margin-top: 12px;">
      <button onclick="confirmBooking()">Confirm</button>
      <button class="secondary" onclick="document.getElementById('confirmDialog').close()">Cancel</button>
    </div>
  </dialog>

  <hr>

  <div class="controls">
    <select id="viewMachine" onchange="renderBookings()">
      <option>Brothers Washer</option>
      <option>Brothers Dryer</option>
      <option>Sisters Washer</option>
      <option>Sisters Dryer</option>
    </select>
    <select id="weekSelector" onchange="renderBookings()"></select>
    <button id="adminLoginBtn" onclick="loginAsAdmin()">üîê Admin</button>
    <button id="adminLogoutBtn" onclick="logoutAdmin()" style="display:none;">üö™ Logout</button>
    <button id="exportCSVBtn" style="display:none; background:#007bff">Export CSV</button>
  </div>

  <div id="weekDisplay"></div>
  <div class="legend">
    <span class="badge processing">Processing</span>
    <span class="badge paid">Paid</span>
    <span class="badge completed">Completed</span>
  </div>

  <div class="bookings"><h3>Weekly Booking Schedule</h3><div id="weeklySchedule"></div></div>
  <button id="resetBookingsBtn" class="reset-button" style="display:none;" onclick="resetAllBookings()">Reset All Bookings</button>

  <dialog id="adminDialog">
    <form method="dialog" id="adminForm">
      <h3>Admin Login</h3>
      <input type="password" id="adminPassword" placeholder="Enter password" />
      <div style="text-align:right; margin-top:8px;">
        <button type="submit">Login</button>
        <button type="button" onclick="document.getElementById('adminDialog').close()" class="secondary">Cancel</button>
      </div>
      <div id="adminError" class="error"></div>
    </form>
  </dialog>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-database-compat.js"></script>
  <script>
    // ========== FIREBASE CONFIG ==========
const firebaseConfig = {
  apiKey: "AIzaSyDT9l-MJ1SJEPF8d2B4Bc0TsrDN1KUdAd0",
  authDomain: "laundrybooking-a986c.firebaseapp.com",
  databaseURL: "https://laundrybooking-a986c-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "laundrybooking-a986c",
  storageBucket: "laundrybooking-a986c.firebasestorage.app",
  messagingSenderId: "927511306519",
  appId: "1:927511306519:web:a360357bcade0d45409752"
};
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>

  <script>
    // ===================== SCHEDULES =====================
    const schedules = {
      "Brothers Washer": { "Sunday":["8:00 AM - 9:00 AM","9:00 AM - 10:00 AM"],"Monday":["8:30 AM - 9:30 AM","9:30 AM - 10:30 AM","10:30 AM - 11:30 AM"],"Tuesday":["1:00 PM - 2:00 PM","2:00 PM - 3:00 PM"],"Wednesday":["8:00 AM - 9:00 AM","9:00 AM - 10:00 AM"],"Thursday":["3:00 PM - 4:00 PM"],"Friday":["8:00 AM - 9:00 AM","9:00 AM - 10:00 AM"],"Saturday":["10:00 AM - 11:00 AM"]},
      "Brothers Dryer": { "Sunday":["8:15 AM - 9:00 AM","9:15 AM - 10:00 AM"],"Monday":["8:45 AM - 9:30 AM","9:45 AM - 10:30 AM"],"Tuesday":["1:15 PM - 2:00 PM","2:15 PM - 3:00 PM"],"Wednesday":["8:15 AM - 9:00 AM"],"Thursday":["3:15 PM - 4:00 PM"],"Friday":["8:15 AM - 9:00 AM"],"Saturday":["10:15 AM - 11:00 AM"]},
      "Sisters Washer": { "Sunday":[],"Monday":["1:00 PM - 2:00 PM","2:00 PM - 3:00 PM"],"Tuesday":["7:00 AM - 8:00 AM"],"Wednesday":["1:00 PM - 2:00 PM"],"Thursday":["4:00 PM - 5:00 PM"],"Friday":["2:00 PM - 3:00 PM"],"Saturday":["9:00 AM - 10:00 AM"]},
      "Sisters Dryer": { "Sunday":[],"Monday":["1:30 PM - 2:15 PM","2:30 PM - 3:15 PM"],"Tuesday":["7:30 AM - 8:15 AM"],"Wednesday":["1:30 PM - 2:15 PM"],"Thursday":["4:15 PM - 5:00 PM"],"Friday":["2:30 PM - 3:15 PM"],"Saturday":["9:30 AM - 10:15 AM"]}
    };

    let isAdmin = false;
    let bookings = [];
    let tempBooking = {};

    // ========== HELPERS ==========
    function pad(n){ return n<10?'0'+n:n; }
    function weekdayNameFromDate(dateStr){ const d=new Date(dateStr+'T00:00:00'); return ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][d.getDay()]; }
    function slotStartFromRange(rangeStr){ return rangeStr.split("-")[0].trim(); }
    function convertStartTo24(timeSlotStart){
      const parts = timeSlotStart.trim().split(" "); if(parts.length<2) return null;
      const [time,ampm]=parts; let [h,m]=time.split(":").map(Number); if(ampm=="PM"&&h<12)h+=12;if(ampm=="AM"&&h==12)h=0; return {h,m}; }

    // ===================== UPDATE TIME SLOTS =====================
    function updateTimeSlots(){
      const machine=document.getElementById("machine").value;
      const date=document.getElementById("date").value;
      const slotSelect=document.getElementById("time");
      slotSelect.innerHTML='<option value="">-- Select a Time Slot --</option>';
      if(!date)return;

      const weekday=weekdayNameFromDate(date);
      const available=schedules[machine][weekday]||[];

      const today=new Date();
      const selDate=new Date(date+"T00:00:00");
      available.forEach(slot=>{
        let disable=false;
        if(selDate.toDateString()===today.toDateString()){
          const {h,m}=convertStartTo24(slotStartFromRange(slot));
          const slotTime=new Date(); slotTime.setHours(h,m,0,0);
          if(slotTime<today) disable=true;
        }
        const option=document.createElement("option"); option.value=slot; option.textContent=slot;
        if(disable) option.disabled=true;
        slotSelect.appendChild(option);
      });
    }

    // ===================== BOOKING FLOW =====================
    function startBooking(){
      const name=document.getElementById("name").value.trim();
      const room=document.getElementById("room").value.trim();
      const date=document.getElementById("date").value;
      const time=document.getElementById("time").value;
      const machine=document.getElementById("machine").value;
      if(!name||!room||!date||!time){ document.getElementById("errorMessage").textContent="All fields are required"; return;}
      document.getElementById("errorMessage").textContent="";

      tempBooking={id:Date.now(), machine,name,room,date,time,status:"Processing",reference:""};
      document.getElementById("paymentDialog").showModal();
    }

    function proceedToConfirmation(){
      const ref=document.getElementById("reference").value.trim();
      if(!ref){ alert("Enter GCash reference number"); return;}
      tempBooking.reference=ref;
      document.getElementById("paymentDialog").close();
      document.getElementById("cMachine").textContent=tempBooking.machine;
      document.getElementById("cName").textContent=tempBooking.name;
      document.getElementById("cRoom").textContent=tempBooking.room;
      document.getElementById("cDate").textContent=tempBooking.date;
      document.getElementById("cTime").textContent=tempBooking.time;
      document.getElementById("cRef").textContent=tempBooking.reference;
      document.getElementById("confirmDialog").showModal();
    }

    function confirmBooking(){
      const bookingRef=db.ref('bookings/'+tempBooking.id);
      bookingRef.set(tempBooking).then(()=>{
        alert("Booking confirmed!");
        tempBooking={};
        document.getElementById("name").value="";
        document.getElementById("room").value="";
        document.getElementById("date").value="";
        document.getElementById("time").innerHTML='<option value="">-- Select a Time Slot --</option>';
        document.getElementById("reference").value="";
        document.getElementById("confirmDialog").close();
        renderBookings();
      }).catch(err=>alert("Error saving booking: "+err));
    }

    // ===================== RENDER BOOKINGS =====================
    function renderBookings(){
      const machine=document.getElementById("viewMachine").value;
      const weekNum=parseInt(document.getElementById("weekSelector").value);
      db.ref('bookings').once('value', snapshot=>{
        bookings=snapshot.val()?Object.values(snapshot.val()):[];

        const startDate=new Date(); startDate.setDate(startDate.getDate()+7*(weekNum-1));
        const weekDates=[]; for(let i=0;i<7;i++){ const d=new Date(startDate); d.setDate(startDate.getDate()+i); weekDates.push(d); }
        const scheduleDiv=document.getElementById("weeklySchedule"); scheduleDiv.innerHTML="";
        document.getElementById("weekDisplay").textContent="Week "+weekNum+" ("+weekDates[0].toLocaleDateString()+" - "+weekDates[6].toLocaleDateString()+")";

        weekDates.forEach(d=>{
          const dateStr=d.toISOString().split("T")[0];
          const weekday=weekdayNameFromDate(dateStr);
          const dayBookings=bookings.filter(b=>b.machine===machine&&b.date===dateStr);

          const dayDiv=document.createElement("div");
          const todayBadge=(new Date().toDateString()===d.toDateString())?'<span class="today-badge">Today</span>':'';
          dayDiv.innerHTML='<strong>'+weekday+' ('+dateStr+') </strong>'+todayBadge;

          const ul=document.createElement("ul");
          schedules[machine][weekday].forEach(slot=>{
            const b=dayBookings.find(bk=>bk.time===slot);
            const li=document.createElement("li");
            if(b){
              li.innerHTML=`${slot} - <span class="status-${b.status.toLowerCase()}">${b.status}</span> ${isAdmin?('<button class="cancel-button" onclick="cancelBooking('+b.id+')">Cancel</button>'):""}`;
            }else{
              li.textContent=slot;
            }
            ul.appendChild(li);
          });
          dayDiv.appendChild(ul);
          scheduleDiv.appendChild(dayDiv);
        });
      });
    }

    // ===================== ADMIN =====================
    function loginAsAdmin(){ document.getElementById("adminDialog").showModal(); }
    document.getElementById("adminForm").addEventListener("submit", e=>{
      e.preventDefault();
      const pass=document.getElementById("adminPassword").value;
      if(pass==="admin123"){ isAdmin=true; document.getElementById("adminDialog").close(); document.getElementById("adminLogoutBtn").style.display="inline-block"; document.getElementById("exportCSVBtn").style.display="inline-block"; document.getElementById("resetBookingsBtn").style.display="inline-block"; renderBookings(); } else { document.getElementById("adminError").textContent="Wrong password"; }
    });
    function logoutAdmin(){ isAdmin=false; document.getElementById("adminLogoutBtn").style.display="none"; document.getElementById("exportCSVBtn").style.display="none"; document.getElementById("resetBookingsBtn").style.display="none"; renderBookings(); }
    function cancelBooking(id){ if(confirm("Cancel this booking?")) db.ref('bookings/'+id).remove().then(()=>renderBookings()); }
    function resetAllBookings(){ if(confirm("Reset all bookings?")) db.ref('bookings').remove().then(()=>renderBookings()); }

    // ===================== WEEK SELECTOR =====================
    function initWeekSelector(){
      const sel=document.getElementById("weekSelector");
      for(let i=1;i<=24;i++){ const o=document.createElement("option"); o.value=i; o.textContent=i; sel.appendChild(o); }
      sel.value=1;
    }

    window.onload=function(){ initWeekSelector(); renderBookings(); };
  </script>
</body>
</html>
