<!DOCTYPE html>
<html>
<head>
  <title>Laundry Booking</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 500px;
      margin: auto;
      padding: 20px;
    }
    input[type="text"], input[type="date"], select {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      font-size: 16px;
    }
    button {
      padding: 10px;
      width: 100%;
      background: green;
      color: white;
      border: none;
      font-size: 16px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .cancel-button {
      background: red;
      color: white;
      border: none;
      padding: 4px 8px;
      font-size: 12px;
      margin-left: 10px;
      cursor: pointer;
      border-radius: 4px;
    }
    .reset-button {
      background: gray;
      margin-top: 10px;
    }
    .error {
      color: red;
      font-size: 14px;
      margin-bottom: 10px;
    }
    #weekDisplay {
      font-weight: bold;
      font-size: 18px;
      margin: 10px 0 20px;
    }
    .status-processing {
      color: orange;
      font-weight: bold;
    }
    .status-paid {
      color: blue;
      font-weight: bold;
    }
    .status-completed {
      color: green;
      font-weight: bold;
    }
    .today-badge {
      color: green;
      font-size: 12px;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <h2>Accomm Laundry Reservation</h2>

  <input type="text" id="name" placeholder="Your Name and FT" />
  <input type="text" id="room" placeholder="Room Number" />
  <input type="date" id="date" onchange="updateTimeSlots()" />
  <select id="time">
    <option value="">-- Select a Time Slot --</option>
  </select>
  <div class="error" id="errorMessage"></div>

  <button onclick="startBooking()">Book Slot</button>

  <dialog id="paymentDialog">
    <h3>Step 2: GCash Payment</h3>
    <p><strong>GCash Number:</strong> 0916-421-9818</p>
    <p><img src="https://upload.wikimedia.org/wikipedia/commons/d/d0/QR_code_for_mobile_English_Wikipedia.svg" alt="QR Code" style="width:100%; max-width:250px;"></p>
    <input type="text" id="reference" placeholder="Enter GCash Reference Number" />
    <div style="text-align:right; margin-top: 20px;">
      <button onclick="proceedToConfirmation()">Next</button>
      <button onclick="document.getElementById('paymentDialog').close()">Cancel</button>
    </div>
  </dialog>

  <dialog id="confirmDialog">
    <h3>Step 3: Confirm Booking</h3>
    <p><strong>Name:</strong> <span id="cName"></span></p>
    <p><strong>Room:</strong> <span id="cRoom"></span></p>
    <p><strong>Date:</strong> <span id="cDate"></span></p>
    <p><strong>Time:</strong> <span id="cTime"></span></p>
    <p><strong>Reference:</strong> <span id="cRef"></span></p>
    <div style="text-align:right; margin-top: 20px;">
      <button onclick="confirmBooking()">Confirm</button>
      <button onclick="document.getElementById('confirmDialog').close()">Cancel</button>
    </div>
  </dialog>

  <div id="weekDisplay"></div>
  <select id="weekSelector" onchange="renderBookings()"></select>
  <div class="bookings"><h3>Weekly Booking Schedule</h3><div id="weeklySchedule"></div></div>

  <button id="adminLoginBtn" onclick="loginAsAdmin()">üîê Login as Admin</button>
  <button id="adminLogoutBtn" onclick="logoutAdmin()" style="display:none;">üö™ Logout Admin</button>
  <button id="resetBookingsBtn" class="reset-button" style="display:none;" onclick="resetAllBookings()">Reset All Bookings</button>

  <dialog id="adminDialog">
    <form method="dialog" id="adminForm">
      <h3>Admin Login</h3>
      <input type="password" id="adminPassword" placeholder="Enter password" />
      <div style="text-align:right;">
        <button type="submit">Login</button>
        <button type="button" onclick="document.getElementById('adminDialog').close()">Cancel</button>
      </div>
      <div id="adminError" class="error"></div>
    </form>
  </dialog>

  <script>
    let isAdmin = false;
    let bookings = JSON.parse(localStorage.getItem("bookings") || "[]");
    let tempBooking = {};

    const timeOptions = {
      0: ["12:00 PM - 1:00 PM"],
      1: ["1:00 PM - 2:00 PM", "3:00 PM - 4:00 PM"],
      2: ["8:00 AM - 9:00 AM", "9:00 AM - 10:00 AM"],
      3: ["10:00 AM - 11:00 AM"],
      4: ["2:00 PM - 3:00 PM", "4:00 PM - 5:00 PM"],
      5: ["6:00 AM - 7:00 AM"],
      6: ["7:00 AM - 8:00 AM", "8:00 AM - 9:00 AM"]
    };

    function getWeekRange(weekIndex = 0) {
      const base = new Date("2025-08-04");
      const start = new Date(base);
      start.setDate(base.getDate() + weekIndex * 7);
      const end = new Date(start);
      end.setDate(start.getDate() + 6);
      return { start, end };
    }

    function populateWeekDropdown() {
      const selector = document.getElementById("weekSelector");
      selector.innerHTML = "";
      const today = new Date();
      let currentWeekIndex = 0;
      for (let i = 0; i < 24; i++) {
        const range = getWeekRange(i);
        const isCurrent = today >= range.start && today <= range.end;
        const option = document.createElement("option");
        option.value = i;
        option.text = `Week ${i + 1} (${range.start.toLocaleDateString()} - ${range.end.toLocaleDateString()})${isCurrent ? " (Current)" : ""}`;
        if (isCurrent) currentWeekIndex = i;
        selector.appendChild(option);
      }
      selector.value = currentWeekIndex;
    }

    function renderBookings() {
      const weekIndex = parseInt(document.getElementById("weekSelector").value || 0);
      const range = getWeekRange(weekIndex);
      const weekStart = range.start;
      const weeklyDiv = document.getElementById("weeklySchedule");
      const weekDisplay = document.getElementById("weekDisplay");
      weeklyDiv.innerHTML = "";
      weekDisplay.textContent = `Showing bookings for: ${range.start.toLocaleDateString()} ‚Äì ${range.end.toLocaleDateString()}`;

      const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
      const today = new Date();
      today.setHours(0, 0, 0, 0); // for clean comparison

      for (let i = 0; i < 7; i++) {
        const thisDate = new Date(weekStart);
        thisDate.setDate(weekStart.getDate() + i);
        const thisDateStr = thisDate.toDateString();
        const isToday = thisDateStr === today.toDateString();

        const dayHeader = document.createElement("h4");
        dayHeader.innerHTML = `${days[thisDate.getDay()]} ${isToday ? '<span class="today-badge">(Today)</span>' : ''}`;

        const dayBlock = document.createElement("div");
        dayBlock.appendChild(dayHeader);

        const dayBookings = bookings
          .map((b, index) => ({ ...b, index }))
          .filter(b => new Date(b.date).toDateString() === thisDateStr)
          .sort((a, b) => a.time.localeCompare(b.time));

        if (dayBookings.length === 0) {
          const p = document.createElement("p");
          p.textContent = "No bookings.";
          dayBlock.appendChild(p);
        } else {
          const ul = document.createElement("ul");
          dayBookings.forEach(b => {
            const li = document.createElement("li");
            const statusClass = b.status.toLowerCase();
            li.innerHTML = `${b.time} - ${b.name} (Room ${b.room}) | Ref: ${b.reference} | <span class="status-${statusClass}">${b.status}</span>`;
            if (isAdmin) {
              const cancelBtn = document.createElement("button");
              cancelBtn.className = "cancel-button";
              cancelBtn.textContent = "Cancel";
              cancelBtn.onclick = () => cancelBooking(b.index);
              li.appendChild(cancelBtn);

              const statusSelect = document.createElement("select");
              ["Processing", "Paid", "Completed"].forEach(status => {
                const opt = document.createElement("option");
                opt.value = opt.text = status;
                if (b.status === status) opt.selected = true;
                statusSelect.appendChild(opt);
              });
              statusSelect.onchange = (e) => updateStatus(b.index, e.target.value);
              statusSelect.style.marginLeft = "10px";
              li.appendChild(statusSelect);
            }
            ul.appendChild(li);
          });
          dayBlock.appendChild(ul);
        }

        weeklyDiv.appendChild(dayBlock);
      }
    }

    function updateTimeSlots() {
      const date = document.getElementById("date").value;
      const timeSelect = document.getElementById("time");
      const error = document.getElementById("errorMessage");
      timeSelect.innerHTML = '<option value="">-- Select a Time Slot --</option>';
      if (!date) return;

      const day = new Date(date).getDay();
      const selectedDay = new Date(date);
      const now = new Date();

      const available = (timeOptions[day] || []).map(slot => {
        const option = document.createElement("option");
        option.value = slot;
        option.textContent = slot;

        const isBooked = bookings.some(b => b.date === date && b.time === slot);
        if (isBooked) {
          option.disabled = true;
          option.textContent += " (Booked)";
          return option;
        }

        if (selectedDay.toDateString() === now.toDateString()) {
          const startTimeStr = slot.split(" - ")[0];
          const slotDateTime = new Date(`${date} ${convertTo24Hour(startTimeStr)}`);
          if (slotDateTime < now) {
            option.disabled = true;
            option.textContent += " (Past)";
          }
        }

        return option;
      });

      available.forEach(opt => timeSelect.appendChild(opt));
      error.textContent = "";
    }

    function startBooking() {
      const name = document.getElementById("name").value.trim();
      const room = document.getElementById("room").value.trim();
      const date = document.getElementById("date").value;
      const time = document.getElementById("time").value;
      const error = document.getElementById("errorMessage");
      error.textContent = "";

      if (!name || !room || !date || !time) {
        error.textContent = "Please complete all fields first.";
        return;
      }

      const today = new Date();
      const selectedDate = new Date(date);
      today.setHours(0, 0, 0, 0);
      selectedDate.setHours(0, 0, 0, 0);

      if (selectedDate <= today) {
        error.textContent = "Same-day or past bookings are not allowed. Please choose a future date.";
        return;
      }

      const now = new Date();
      const startTimeStr = time.split(" - ")[0];
      const bookingDateTime = new Date(`${date} ${convertTo24Hour(startTimeStr)}`);
      if (bookingDateTime < now) {
        error.textContent = "You cannot book a time in the past.";
        return;
      }

      const conflict = bookings.some(b => b.date === date && b.time === time);
      if (conflict) {
        error.textContent = "This time slot is already booked.";
        return;
      }

      tempBooking = { name, room, date, time, reference: "", status: "Processing" };
      document.getElementById("paymentDialog").showModal();
    }

    function proceedToConfirmation() {
      const ref = document.getElementById("reference").value.trim();
      if (!ref) return alert("Please enter GCash reference number.");
      tempBooking.reference = ref;

      document.getElementById("cName").textContent = tempBooking.name;
      document.getElementById("cRoom").textContent = tempBooking.room;
      document.getElementById("cDate").textContent = tempBooking.date;
      document.getElementById("cTime").textContent = tempBooking.time;
      document.getElementById("cRef").textContent = tempBooking.reference;

      document.getElementById("paymentDialog").close();
      document.getElementById("confirmDialog").showModal();
    }

    function confirmBooking() {
      bookings.push(tempBooking);
      localStorage.setItem("bookings", JSON.stringify(bookings));
      document.getElementById("confirmDialog").close();
      renderBookings();
      alert("Booking confirmed!");

      document.getElementById("name").value = "";
      document.getElementById("room").value = "";
      document.getElementById("date").value = "";
      document.getElementById("time").innerHTML = '<option value="">-- Select a Time Slot --</option>';
      document.getElementById("reference").value = "";
    }

    function cancelBooking(index) {
      if (!isAdmin) return alert("Only admin can cancel bookings.");
      if (confirm("Are you sure you want to cancel this booking?")) {
        bookings.splice(index, 1);
        localStorage.setItem("bookings", JSON.stringify(bookings));
        renderBookings();
      }
    }

    function updateStatus(index, status) {
      bookings[index].status = status;
      localStorage.setItem("bookings", JSON.stringify(bookings));
      renderBookings();
    }

    function loginAsAdmin() {
      const dialog = document.getElementById("adminDialog");
      const form = document.getElementById("adminForm");
      const input = document.getElementById("adminPassword");
      const error = document.getElementById("adminError");

      input.value = "";
      error.textContent = "";
      dialog.showModal();

      form.onsubmit = function () {
        if (input.value === "admin123") {
          isAdmin = true;
          dialog.close();
          document.getElementById("resetBookingsBtn").style.display = "block";
          document.getElementById("adminLoginBtn").style.display = "none";
          document.getElementById("adminLogoutBtn").style.display = "block";
          renderBookings();
        } else {
          error.textContent = "Incorrect password.";
        }
      };
    }

    function logoutAdmin() {
      isAdmin = false;
      document.getElementById("resetBookingsBtn").style.display = "none";
      document.getElementById("adminLoginBtn").style.display = "block";
      document.getElementById("adminLogoutBtn").style.display = "none";
      renderBookings();
    }

    function resetAllBookings() {
      if (confirm("Are you sure you want to delete ALL bookings? This cannot be undone.")) {
        bookings = [];
        localStorage.setItem("bookings", JSON.stringify(bookings));
        renderBookings();
        alert("All bookings have been cleared.");
      }
    }

    function convertTo24Hour(timeStr) {
      const [time, modifier] = timeStr.split(" ");
      let [hours, minutes] = time.split(":");
      if (hours === "12") hours = "00";
      if (modifier === "PM") hours = parseInt(hours, 10) + 12;
      return `${hours}:${minutes}:00`;
    }

    populateWeekDropdown();
    renderBookings();
  </script>
</body>
</html>
